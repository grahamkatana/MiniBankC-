<!DOCTYPE html>
<html>
<head>
    <title>MiniBank Real-time Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
</head>
<body>
    <h1>MiniBank Real-time Notifications</h1>
    
    <div>
        <label>JWT Token:</label>
        <input type="text" id="token" style="width: 500px" placeholder="Paste JWT token here">
    </div>
    
    <div>
        <label>Account Number:</label>
        <input type="text" id="accountNumber" value="ACC-20260102-0001">
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    
    <h3>Status: <span id="status">Disconnected</span></h3>
    
    <h3>Messages:</h3>
    <div id="messages" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll;"></div>

    <script>
        let connection = null;

        async function connect() {
            const token = document.getElementById('token').value;
            const accountNumber = document.getElementById('accountNumber').value;

            if (!token) {
                alert('Please enter JWT token');
                return;
            }

            connection = new signalR.HubConnectionBuilder()
                .withUrl("https://minibank.tekbridge.co.za/hubs/transactions", {
                    accessTokenFactory: () => token
                })
                .withAutomaticReconnect()
                .build();

            connection.on("Connected", (message) => {
                addMessage('System', message);
            });

            connection.on("Joined", (message) => {
                addMessage('System', message);
            });

            connection.on("TransactionCreated", (data) => {
                addMessage('Transaction', JSON.stringify(data, null, 2));
            });

            connection.on("BalanceUpdated", (data) => {
                addMessage('Balance', JSON.stringify(data, null, 2));
            });

            try {
                await connection.start();
                document.getElementById('status').textContent = 'Connected';
                
                // Join account group
                await connection.invoke("JoinAccountGroup", accountNumber);
            } catch (err) {
                console.error(err);
                addMessage('Error', err.toString());
            }
        }

        async function disconnect() {
            if (connection) {
                await connection.stop();
                document.getElementById('status').textContent = 'Disconnected';
            }
        }

        function addMessage(type, message) {
            const div = document.createElement('div');
            div.style.marginBottom = '10px';
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()} - ${type}:</strong> ${message}`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }
    </script>
</body>
</html>